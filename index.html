<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Ganadero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CARGA DE CHART.JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      padding: 20px;
      margin: 0;
    }
    #login {
      max-width: 400px;
      margin: 80px auto;
      padding: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    canvas {
      background: white;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      background: #2e7d32;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #1b5e20; }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
      max-height: 160px;
    }
    .card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
      font-weight: bold;
      color: #2e7d32;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h2>üîê Dashboard Ganadero</h2>
  <p>Ingresa tu correo registrado:</p>
  <input type="email" id="email" placeholder="tu@correo.com" value="vicmary.j@gmail.com" />
  <button id="btnLogin">Acceder</button>
  <p id="msg" style="color:#d32f2f; min-height:1.2em;"></p>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <h1>Dashboard Ganadero</h1>
  <button id="btnLogout" style="width:auto;">Salir</button>
  
  <div class="summary">
    <div class="card"><div id="total">‚Äî</div>Total</div>
    <div class="card"><div id="tipos">‚Äî</div>Tipos</div>
    <div class="card"><div id="lotes">‚Äî</div>Lotes</div>
    <div class="card"><div id="movs">‚Äî</div>Movs</div>
  </div>

  <div class="charts">
    <div><canvas id="tiposChart" height="250"></canvas></div>
    <div><canvas id="lotesChart" height="250"></canvas></div>
    <div><canvas id="histChart" height="250"></canvas></div>
    <div><canvas id="pesosChart" height="250"></canvas></div>
  </div>

  <h3>Movimientos recientes</h3>
  <pre id="movData">Cargando...</pre>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxYBk6yBlVEMIYlE0g5070PXhdK7__4vwqwZTd09I3qh1OZuWEExX68RY98cZY8QebIeA/exec";

let currentEmail = null;
let charts = {};

// ========== JSONP CALL ==========
function callBackend(action, email, callback) {
  const scriptId = 'jsonp_' + Date.now();
  
  window[scriptId] = (data) => {
    delete window[scriptId];
    document.getElementById(scriptId)?.remove();
    callback(null, data);
  };

  const script = document.createElement('script');
  script.id = scriptId;
  script.src = `${WEBAPP_URL}?action=${action}&email=${encodeURIComponent(email)}&callback=${scriptId}`;

  script.onerror = () => {
    delete window[scriptId];
    script.remove();
    callback(new Error("Fallo de red"));
  };

  document.head.appendChild(script);
}

// ========== LOGIN ==========
document.getElementById('btnLogin').addEventListener('click', () => {
  const email = document.getElementById('email').value.trim();
  const msg = document.getElementById('msg');
  msg.textContent = "";

  if (!email.includes('@')) {
    msg.textContent = "Correo inv√°lido";
    return;
  }

  msg.textContent = "Verificando...";
  callBackend('auth', email, (err, data) => {
    if (err || !data.autorizado) {
      msg.textContent = "Acceso denegado";
    } else {
      currentEmail = email;
      document.getElementById('login').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadAll();
    }
  });
});

// ========== LOGOUT ==========
document.getElementById('btnLogout').addEventListener('click', () => {
  currentEmail = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login').style.display = 'block';
});

// ========== LOAD ALL DATA ==========
function loadAll() {
  const endpoints = ['tipos', 'lotes', 'inventario', 'movimientos', 'historico', 'pesos'];
  let results = {};
  let loaded = 0;

  const onResult = (key, err, data) => {
    if (err) {
      console.error("Error en", key, err);
      return;
    }
    results[key] = data;
    loaded++;

    if (loaded === endpoints.length) render(results);
  };

  endpoints.forEach(key => {
    callBackend(key, currentEmail, (err, data) => onResult(key, err, data));
  });
}

// ========== RENDER ==========
function render(data) {

  document.getElementById('total').textContent = data.inventario?.total ?? 0;
  document.getElementById('tipos').textContent = data.tipos?.length ?? 0;
  document.getElementById('lotes').textContent = data.lotes?.length ?? 0;
  document.getElementById('movs').textContent = data.movimientos?.total ?? 0;

  // Movimientos
  document.getElementById('movData').textContent =
    JSON.stringify(data.movimientos?.conteoPorMotivo || [], null, 2);

  // GraÃÅficos
  drawChart('tiposChart', 'pie', data.tipos, 'tipo', 'cantidad');
  drawChart('lotesChart', 'bar', data.lotes, 'lote', 'cantidad');
  drawChart('histChart', 'line', data.historico, 'fecha', 'total', v => new Date(v).toLocaleDateString());
  drawChart('pesosChart', 'bar', avgByLote(data.pesos), 'lote', 'peso');
}

// ========== AGRUPAMIENTO ==========
function avgByLote(pesos) {
  if (!Array.isArray(pesos)) return [];

  const groups = {};

  pesos.forEach(r => {
    const l = r.lote || 'SIN LOTE';
    const p = Number(r.peso);

    if (isNaN(p)) return;

    if (!groups[l]) groups[l] = { sum: 0, n: 0 };
    groups[l].sum += p;
    groups[l].n++;
  });

  return Object.entries(groups).map(([lote, v]) => ({
    lote,
    peso: Math.round((v.sum / v.n) * 10) / 10
  }));
}

// ========== DIBUJAR CHART ==========
function drawChart(id, type, data, labelKey, valueKey, labelFormatter = v => v) {

  const canvas = document.getElementById(id);
  if (charts[id]) charts[id].destroy();

  if (!Array.isArray(data)) data = [];

  const labels = data.map(item => labelFormatter(item[labelKey]));
  const values = data.map(item => Number(item[valueKey]) || 0);

  const ctx = canvas.getContext('2d');

  charts[id] = new Chart(ctx, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: getColors(values.length),
        borderColor: '#333',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: type === 'pie' ? {} : {
        y: { beginAtZero: true }
      }
    }
  });
}

function getColors(n) {
  const palette = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#FF5722', '#009688', '#607D8B'];
  return Array.from({ length: n }, (_, i) => palette[i % palette.length]);
}
</script>
</body>
</html>
